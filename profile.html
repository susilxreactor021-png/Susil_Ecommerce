<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Susil | Profile</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 flex flex-col min-h-screen">

<!-- Header -->
<header class="bg-blue-700 text-white sticky top-0 z-50 shadow">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <a href="index.html" class="text-2xl font-bold">Susil</a>
      <nav>
        <ul class="flex space-x-6">
          <li>
            <a href="dashboard.html" 
               class="text-gray-200 hover:text-white transition font-medium">
              Dashboard
            </a>
          </li>
        </ul>
      </nav>
    <nav class="hidden md:flex space-x-6 font-medium">
      <button id="logoutBtnDesktop" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition">Sign Out</button>
    </nav>
    <button id="menuToggle" class="md:hidden p-2" aria-label="Toggle menu" aria-expanded="false">☰</button>
  </div>
</header>

<!-- Mobile Menu -->
<div id="menu" class="hidden md:hidden bg-blue-700 text-white px-4 py-3 space-y-2" aria-hidden="true">
  <button id="logoutBtnMobile" class="block w-full bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition">Sign Out</button>
</div>

<!-- Main Profile Content -->
<main class="max-w-5xl mx-auto px-4 py-12 flex-1">
  <h1 class="text-3xl font-bold mb-8 text-center">My Profile</h1>

  <div class="bg-white rounded-xl shadow-lg p-6 grid grid-cols-1 md:grid-cols-3 gap-8">
    <!-- Left Column -->
    <div class="flex flex-col items-center md:items-start space-y-4">
      <img id="userPhoto" src="https://via.placeholder.com/150" 
           alt="Profile Picture" 
           class="w-32 h-32 rounded-full border-4 border-blue-700 object-cover">
      <h2 id="userName" class="text-xl font-semibold text-center md:text-left">Loading...</h2>
      <p id="userEmail" class="text-gray-600 text-center md:text-left break-words">Loading...</p>

      <label class="block w-full">
        <input type="file" class="hidden" accept="image/*" id="photoUpload">
        <button type="button" id="uploadBtn" 
                class="bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800 transition w-full md:w-auto">
          Change Photo
        </button>
      </label>
      <p id="uploadStatus" class="text-sm text-gray-600"></p>
    </div>

    <!-- Right Column (Tabs + Forms) -->
    <div class="md:col-span-2 space-y-6">
    
      <!-- Tabs -->
      <div class="flex space-x-4 border-b overflow-x-auto">
        <button class="tab-btn py-2 px-4 font-medium border-b-2 border-blue-700 text-blue-700" data-tab="info">Profile Info</button>
        <button class="tab-btn py-2 px-4 font-medium text-gray-600 hover:text-blue-700" data-tab="security">Security</button>
        <button class="tab-btn py-2 px-4 font-medium text-gray-600 hover:text-blue-700" data-tab="settings">Settings</button>
      </div>

      <!-- Profile Info Tab -->
      <div class="tab-content" id="tab-info">
        <form id="profileForm" class="space-y-4">
          <div>
            <label class="block mb-1 font-medium">Full Name</label>
            <input type="text" id="nameInput" class="w-full border rounded-lg px-4 py-2 outline-none" />
          </div>
          <div>
            <label class="block mb-1 font-medium">Phone</label>
            <input type="tel" id="phoneInput" class="w-full border rounded-lg px-4 py-2 outline-none" placeholder="Enter phone number" />
          </div>
          <div>
            <label class="block mb-1 font-medium">Address</label>
            <input type="text" id="addressInput" class="w-full border rounded-lg px-4 py-2 outline-none" placeholder="Enter address" />
          </div>
          <button type="submit" class="bg-blue-700 text-white px-6 py-2 rounded-lg hover:bg-blue-800 transition">Save Changes</button>
        </form>
      </div>

      <!-- Security Tab -->
      <div class="tab-content hidden" id="tab-security">
        <form id="securityForm" class="space-y-4">
          <div>
            <label class="block mb-1 font-medium">Current Password</label>
            <input type="password" class="w-full border rounded-lg px-4 py-2 outline-none" />
          </div>
          <div>
            <label class="block mb-1 font-medium">New Password</label>
            <input type="password" class="w-full border rounded-lg px-4 py-2 outline-none" />
          </div>
          <button type="submit" class="bg-blue-700 text-white px-6 py-2 rounded-lg hover:bg-blue-800 transition">Update Password</button>
        </form>
      </div>

      <!-- Settings Tab -->
      <div class="tab-content hidden" id="tab-settings">
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <span>Email Notifications</span>
            <input type="checkbox" class="h-5 w-5" checked />
          </div>
          <div class="flex items-center justify-between">
            <span>Dark Mode</span>
            <input type="checkbox" class="h-5 w-5" />
          </div>
          <button class="bg-blue-700 text-white px-6 py-2 rounded-lg hover:bg-blue-800 transition">Save Settings</button>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Footer -->
<footer class="bg-blue-700 text-white py-6 mt-auto">
  <div class="max-w-6xl mx-auto px-4 text-center">
    <p>© <span id="year"></span> Susil. All rights reserved.</p>
  </div>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAtiUwmMiKpDcls-K1j_gCbPL8v89wn4oU",
    authDomain: "susil-b6932.firebaseapp.com",
    projectId: "susil-b6932",
    storageBucket: "susil-b6932.appspot.com",
    messagingSenderId: "708671348480",
    appId: "1:708671348480:web:8681a62c325762312b1de5",
    measurementId: "G-PYCNBH7THZ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const storage = getStorage(app);
  const db = getFirestore(app);
  document.getElementById("year").textContent = new Date().getFullYear();

  const userName = document.getElementById('userName');
  const userEmail = document.getElementById('userEmail');
  const userPhoto = document.getElementById('userPhoto');
  const nameInput = document.getElementById('nameInput');
  const phoneInput = document.getElementById('phoneInput');
  const addressInput = document.getElementById('addressInput');
  const uploadStatus = document.getElementById('uploadStatus');

  // Mobile menu toggle
  document.getElementById('menuToggle').onclick = () => {
    const menu = document.getElementById('menu');
    menu.classList.toggle('hidden');
  };

  // Load user data
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }
    userName.textContent = user.displayName || "No name set";
    userEmail.textContent = user.email;
    userPhoto.src = user.photoURL || "https://via.placeholder.com/150";
    nameInput.value = user.displayName || "";

    // Load extra fields from Firestore
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (userDoc.exists()) {
      const data = userDoc.data();
      phoneInput.value = data.phone || "";
      addressInput.value = data.address || "";
    }
  });

  // Upload profile photo
  document.getElementById('photoUpload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    uploadStatus.textContent = "Uploading...";
    try {
      const user = auth.currentUser;
      if (!user) return;

      const ext = file.name.split('.').pop();
      const storageRef = ref(storage, `profilePictures/${user.uid}.${ext}`);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);

      await updateProfile(user, { photoURL: url });
      userPhoto.src = url + "?t=" + new Date().getTime(); // cache-buster
      uploadStatus.textContent = "Profile picture updated!";
    } catch (err) {
      console.error(err);
      uploadStatus.textContent = "Upload failed: " + err.message;
    }
  });
  document.getElementById('uploadBtn').onclick = () => {
    document.getElementById('photoUpload').click();
  };

  // Save profile info
  document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) return;
    try {
      await updateProfile(user, { displayName: nameInput.value });
      await setDoc(doc(db, "users", user.uid), {
        phone: phoneInput.value,
        address: addressInput.value
      }, { merge: true });
      alert("Profile updated successfully!");
    } catch (err) {
      console.error(err);
      alert("Error: " + err.message);
    }
  });

  // Logout buttons
  [document.getElementById('logoutBtnDesktop'), document.getElementById('logoutBtnMobile')].forEach(btn => {
    btn.onclick = async () => {
      await signOut(auth);
      window.location.href = "index.html";
    };
  });

  // Tabs
  const tabBtns = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      tabBtns.forEach(b => b.classList.remove('border-blue-700','border-b-2','text-blue-700'));
      btn.classList.add('border-blue-700','border-b-2','text-blue-700');
      const target = btn.dataset.tab;
      tabContents.forEach(tc => tc.classList.add('hidden'));
      document.getElementById(`tab-${target}`).classList.remove('hidden');
    });
  });
</script>

</body>
</html>
