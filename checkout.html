<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">

  <!-- Header -->
  <header class="bg-orange-600 text-white p-4 text-center text-xl font-bold shadow">
    Checkout
  </header>

  <main class="max-w-6xl mx-auto p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">

    <!-- Order Summary -->
    <section class="lg:col-span-1 bg-white p-5 rounded-2xl shadow">
      <h2 class="text-lg font-bold mb-4">Order Summary</h2>
      <div id="orderItems" class="space-y-4 max-h-72 overflow-y-auto pr-2"></div>
      <div class="border-t pt-4 mt-4 flex justify-between font-semibold text-lg">
        <span>Total:</span>
        <span>$<span id="orderTotal">0.00</span></span>
      </div>
    </section>

    <!-- Checkout Form -->
    <section class="md:col-span-1 lg:col-span-2 bg-white p-5 rounded-2xl shadow">
      <h2 class="text-lg font-bold mb-4">Shipping & Payment</h2>
      <form id="checkoutForm" class="space-y-6" onsubmit="handleSubmit(event)">

        <!-- Shipping Info -->
        <div>
          <label for="name" class="block font-medium mb-1">Full Name</label>
          <input type="text" id="name" class="w-full border rounded p-2 focus:ring-2 focus:ring-orange-500" required>
        </div>
        <div>
          <label for="address" class="block font-medium mb-1">Address</label>
          <input type="text" id="address" class="w-full border rounded p-2 focus:ring-2 focus:ring-orange-500" required>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label for="city" class="block font-medium mb-1">City</label>
            <input type="text" id="city" class="w-full border rounded p-2 focus:ring-2 focus:ring-orange-500" required>
          </div>
          <div>
            <label for="zip" class="block font-medium mb-1">Zip</label>
            <input type="text" id="zip" class="w-full border rounded p-2 focus:ring-2 focus:ring-orange-500" required>
          </div>
        </div>

        <!-- Payment Method -->
        <div>
          <label class="block font-medium mb-2">Payment Method</label>
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- Visa -->
            <label class="flex items-center gap-2 border rounded-lg p-2 cursor-pointer hover:border-orange-500">
              <input type="radio" name="payment" value="visa" required>
              <img src="https://img.icons8.com/color/48/visa.png" class="h-6" alt="Visa">
            </label>
            <!-- MasterCard -->
            <label class="flex items-center gap-2 border rounded-lg p-2 cursor-pointer hover:border-orange-500">
              <input type="radio" name="payment" value="mastercard">
              <img src="https://img.icons8.com/color/48/mastercard.png" class="h-6" alt="MasterCard">
            </label>
            <!-- PayPal -->
            <label class="flex items-center gap-2 border rounded-lg p-2 cursor-pointer hover:border-orange-500">
              <input type="radio" name="payment" value="paypal">
              <img src="https://img.icons8.com/color/48/paypal.png" class="h-6" alt="PayPal">
            </label>
            <!-- eSewa -->
            <label class="flex items-center gap-2 border rounded-lg p-2 cursor-pointer hover:border-orange-500">
              <input type="radio" name="payment" value="esewa">
              <img src="Logo/Esewa icon.png" class="h-6" alt="eSewa">
            </label>
            <!-- Khalti -->
            <label class="flex items-center gap-2 border rounded-lg p-2 cursor-pointer hover:border-orange-500">
              <input type="radio" name="payment" value="khalti">
              <img src="Logo/Khalti icon.png" class="h-6" alt="Khalti">
            </label>
            <!-- Cash on Delivery -->
            <label class="flex items-center gap-2 border rounded-lg p-2 cursor-pointer hover:border-orange-500">
              <input type="radio" name="payment" value="cod">
              <span class="text-sm font-medium">Cash</span>
            </label>
          </div>
        </div>

        <!-- Payment Instructions (for eSewa/Khalti) -->
        <div id="paymentInstructions" class="hidden p-4 bg-yellow-100 border border-yellow-500 rounded-lg">
          <p class="font-medium">You will be redirected to your selected payment method's account to complete your payment:</p>
          <ol class="list-decimal ml-6">
            <li>Login to your account using your credentials.</li>
            <li>Ensure your account has sufficient balance.</li>
            <li>Enter OTP sent to your registered mobile number (if applicable).</li>
            <li>Click "Pay Now" to complete the transaction.</li>
          </ol>
          <button id="payNowBtn" class="mt-4 w-full bg-orange-600 text-white py-3 rounded-lg hover:bg-orange-700 font-semibold text-lg">
            Pay Now
          </button>
        </div>

        <!-- Submit Button -->
        <button type="submit" id="submitBtn" class="w-full bg-orange-600 text-white py-3 rounded-lg hover:bg-orange-700 font-semibold text-lg">
          Place Order
        </button>
      </form>
    </section>
  </main>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="text-white text-lg">Processing...</div>
  </div>

  <script>
    const orderItems = document.getElementById("orderItems");
    const orderTotal = document.getElementById("orderTotal");
    const checkoutForm = document.getElementById("checkoutForm");
    const paymentInstructions = document.getElementById("paymentInstructions");
    const payNowBtn = document.getElementById("payNowBtn");
    const submitBtn = document.getElementById("submitBtn");
    const loadingSpinner = document.getElementById("loadingSpinner");

    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    let total = 0;

    function renderOrder() {
      orderItems.innerHTML = "";
      total = 0;
      const grouped = {};
      cart.forEach(item => {
        if (!grouped[item.id]) grouped[item.id] = { ...item, qty: 0 };
        grouped[item.id].qty++;
      });
      Object.values(grouped).forEach(item => {
        total += item.price * item.qty;
        const div = document.createElement("div");
        div.className = "flex items-center justify-between gap-4 border-b pb-2";
        div.innerHTML = `
          <div class="flex items-center gap-3">
            <img src="${item.imgLocal || item.img || 'https://via.placeholder.com/60'}"
                 class="w-14 h-14 rounded object-cover"
                 alt="${item.title}">
            <span class="text-sm font-medium">${item.title} × ${item.qty}</span>
          </div>
          <span class="font-medium text-sm">$${(item.price * item.qty).toFixed(2)}</span>
        `;
        orderItems.appendChild(div);
      });
      orderTotal.textContent = total.toFixed(2);
    }

    function handleSubmit(event) {
      event.preventDefault();

      if (cart.length === 0) {
        alert("Your cart is empty!");
        return;
      }

      const paymentMethod = checkoutForm.payment.value;
      const order = {
        id: Date.now(),
        items: cart,
        total,
        date: new Date().toLocaleString(),
        payment: paymentMethod,
        status: ["paypal", "esewa", "khalti"].includes(paymentMethod) ? "Pending" : "Paid",
        shipping: {
          name: document.getElementById("name").value,
          address: document.getElementById("address").value,
          city: document.getElementById("city").value,
          zip: document.getElementById("zip").value
        }
      };

      const orders = JSON.parse(localStorage.getItem("orders")) || [];
      orders.push(order);
      localStorage.setItem("orders", JSON.stringify(orders));
      localStorage.removeItem("cart");

      submitBtn.disabled = true;
      submitBtn.textContent = "Processing...";

      setTimeout(() => {
        alert(`✅ Order placed successfully!`);
        submitBtn.disabled = false;
        submitBtn.textContent = "Place Order";
        window.location.href = "orders.html";
      }, 2000);
    }

    checkoutForm.addEventListener("change", (e) => {
      if (e.target.name === "payment") {
        if (["esewa", "khalti"].includes(e.target.value)) {
          paymentInstructions.classList.remove("hidden");
        } else {
          paymentInstructions.classList.add("hidden");
        }
      }
    });

    payNowBtn.addEventListener("click", () => {
      const paymentMethod = checkoutForm.payment.value;
      let redirectUrl = "";
      if (paymentMethod === "esewa") {
        redirectUrl = "https://www.esewa.com.np";
      } else if (paymentMethod === "khalti") {
        redirectUrl = "https://www.khalti.com/merchant";
      }
      if (redirectUrl) {
        window.open(redirectUrl, "_blank");
      }
    });

    renderOrder();
  </script>

</body>
</html>
