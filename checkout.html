<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 text-gray-900">

<!-- ================= HEADER ================= -->
<header class="bg-orange-600 text-white p-4 text-center text-xl font-bold shadow">
  Checkout
</header>

<!-- ================= MAIN ================= -->
<main class="max-w-6xl mx-auto p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">

  <!-- ========== ORDER SUMMARY ========== -->
  <section class="lg:col-span-1 bg-white p-5 rounded-2xl shadow">
    <h2 class="text-lg font-bold mb-4">Order Summary</h2>

    <div id="orderItems" class="space-y-4 max-h-72 overflow-y-auto pr-2"></div>

    <div class="border-t pt-4 mt-4 flex justify-between font-semibold text-lg">
      <span>Total:</span>
      <span>$<span id="orderTotal">0.00</span></span>
    </div>
  </section>

  <!-- ========== CHECKOUT FORM ========== -->
  <section class="md:col-span-1 lg:col-span-2 bg-white p-5 rounded-2xl shadow">
    <h2 class="text-lg font-bold mb-4">Shipping & Payment</h2>

    <form id="checkoutForm" class="space-y-6">

      <!-- SHIPPING -->
      <div>
        <label class="block font-medium mb-1">Full Name</label>
        <input id="name" required
          class="w-full border rounded p-2 focus:ring-2 focus:ring-orange-500">
      </div>

      <div>
        <label class="block font-medium mb-1">Address</label>
        <input id="address" required
          class="w-full border rounded p-2 focus:ring-2 focus:ring-orange-500">
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block font-medium mb-1">City</label>
          <input id="city" required
            class="w-full border rounded p-2 focus:ring-2 focus:ring-orange-500">
        </div>

        <div>
          <label class="block font-medium mb-1">Zip</label>
          <input id="zip" required
            class="w-full border rounded p-2 focus:ring-2 focus:ring-orange-500">
        </div>
      </div>

      <!-- PAYMENT -->
      <div>
        <label class="block font-medium mb-2">Payment Method</label>

        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">

          <label class="flex items-center gap-2 border rounded-lg p-2 cursor-pointer">
            <input type="radio" name="payment" value="visa" required>
            <img src="https://img.icons8.com/color/48/visa.png" class="h-6">
          </label>

          <label class="flex items-center gap-2 border rounded-lg p-2 cursor-pointer">
            <input type="radio" name="payment" value="mastercard">
            <img src="https://img.icons8.com/color/48/mastercard.png" class="h-6">
          </label>

          <label class="flex items-center gap-2 border rounded-lg p-2 cursor-pointer">
            <input type="radio" name="payment" value="paypal">
            <img src="https://img.icons8.com/color/48/paypal.png" class="h-6">
          </label>

          <label class="flex items-center gap-2 border rounded-lg p-2 cursor-pointer">
            <input type="radio" name="payment" value="esewa">
            <img src="Logo/Esewa icon.png" class="h-6">
          </label>

          <label class="flex items-center gap-2 border rounded-lg p-2 cursor-pointer">
            <input type="radio" name="payment" value="khalti">
            <img src="Logo/Khalti icon.png" class="h-6">
          </label>

          <label class="flex items-center gap-2 border rounded-lg p-2 cursor-pointer">
            <input type="radio" name="payment" value="cod">
            <span>Cash</span>
          </label>

        </div>
      </div>

      <!-- ONLINE PAYMENT NOTICE -->
      <div id="paymentInstructions"
        class="hidden p-4 bg-yellow-100 border rounded-lg">
        <p class="font-medium mb-2">
          You will be redirected to complete payment.
        </p>
        <button type="button" id="payNowBtn"
          class="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold">
          Pay Now
        </button>
      </div>

      <!-- SUBMIT -->
      <button id="submitBtn"
        class="w-full bg-orange-600 text-white py-3 rounded-lg font-semibold">
        Place Order
      </button>

    </form>
  </section>
</main>

<!-- ================= SCRIPT ================= -->
<script>
const orderItems = document.getElementById("orderItems");
const orderTotal = document.getElementById("orderTotal");
const checkoutForm = document.getElementById("checkoutForm");
const paymentInstructions = document.getElementById("paymentInstructions");
const payNowBtn = document.getElementById("payNowBtn");
const submitBtn = document.getElementById("submitBtn");

let cart = JSON.parse(localStorage.getItem("cart")) || [];
let total = 0;

/* ---------- RENDER ORDER SUMMARY ---------- */
function renderOrder() {
  orderItems.innerHTML = "";
  total = 0;

  const grouped = {};
  cart.forEach(item => {
    if (!grouped[item.id]) grouped[item.id] = { ...item, qty: 0 };
    grouped[item.id].qty++;
  });

  Object.values(grouped).forEach(item => {
    total += item.price * item.qty;

    const img =
      item.img ||
      item.imgLocal ||
      "https://via.placeholder.com/60";

    orderItems.innerHTML += `
      <div class="flex justify-between items-center border-b pb-2">
        <div class="flex gap-3 items-center">
          <img src="${img}" class="w-14 h-14 rounded object-cover border">
          <span class="text-sm font-medium">
            ${item.title || item.name} × ${item.qty}
          </span>
        </div>
        <span class="font-medium">$${(item.price * item.qty).toFixed(2)}</span>
      </div>
    `;
  });

  orderTotal.textContent = total.toFixed(2);
}

/* ---------- PAYMENT TOGGLE ---------- */
checkoutForm.addEventListener("change", e => {
  if (["esewa", "khalti"].includes(e.target.value)) {
    paymentInstructions.classList.remove("hidden");
  } else {
    paymentInstructions.classList.add("hidden");
  }
});

/* ---------- SUBMIT ORDER ---------- */
checkoutForm.onsubmit = e => {
  e.preventDefault();
  if (!cart.length) return alert("Cart is empty!");

  const orders = JSON.parse(localStorage.getItem("orders")) || [];

  const normalizedItems = cart.map(item => ({
    id: item.id || crypto.randomUUID(),
    title: item.title || item.name || "Product",
    price: Number(item.price) || 0,
    img: item.img || item.imgLocal || "https://via.placeholder.com/60"
  }));

  orders.push({
    id: Date.now(),
    date: new Date().toLocaleString(),
    items: normalizedItems,
    total: total,
    payment: checkoutForm.payment.value,
    status: "Pending",
    shipping: {
      name: name.value,
      address: address.value,
      city: city.value,
      zip: zip.value
    }
  });

  localStorage.setItem("orders", JSON.stringify(orders));
  localStorage.removeItem("cart");

  submitBtn.textContent = "Processing...";
  submitBtn.disabled = true;

  setTimeout(() => {
    alert("✅ Order placed successfully!");
    location.href = "orders.html";
  }, 1000);
};

/* ---------- PAYMENT REDIRECT ---------- */
payNowBtn.onclick = () => {
  const m = checkoutForm.payment.value;
  if (m === "esewa") window.open("https://www.esewa.com.np", "_blank");
  if (m === "khalti") window.open("https://www.khalti.com", "_blank");
};

renderOrder();
</script>

</body>
</html>
